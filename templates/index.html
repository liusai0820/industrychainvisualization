<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产业链全景图谱分析系统</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="main-title">产业链全景图谱分析系统</h1>
            <p class="sub-title">输入产业链名称，快速生成完整产业链图谱</p>
            <div class="search-container">
                <input 
                    type="text" 
                    id="industry-input" 
                    placeholder="请输入产业链名称，如：AI芯片、新能源汽车等" />
                <button id="search-btn">生成图谱</button>
            </div>
        </header>
        
        <main id="chart-container">
            <div class="chart-wrapper"></div>
        </main>
    </div>

    <script>
        // 初始化图表
        const chartContainer = document.querySelector('.chart-wrapper');
        const chart = echarts.init(chartContainer);

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        async function fetchGraphData(industryName = '') {
            try {
                chart.showLoading({
                    text: '数据加载中...',
                    color: '#516B91',
                    textColor: '#516B91',
                    maskColor: 'rgba(255, 255, 255, 0.9)'
                });

                const response = await fetch('/get_graph_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ industry_name: industryName })
                });

                const data = await response.json();
                chart.hideLoading();

                if (!response.ok || data.error) {
                    showError(data.error || '获取数据失败');
                    return;
                }

                updateChart(data);
            } catch (error) {
                console.error('Error:', error);
                chart.hideLoading();
                showError('获取数据失败，请稍后重试');
            }
        }

        function updateChart(data) {
            const option = {
                backgroundColor: '#FFFFFF',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}',
                    backgroundColor: 'rgba(50,50,50,0.9)',
                    padding: [5, 10],
                    textStyle: {
                        color: '#fff'
                    }
                },
                series: [{
                    type: 'tree',
                    data: [data],
                    left: '10%',
                    right: '35%',
                    top: '5%',
                    bottom: '5%',
                    symbol: 'emptyCircle',
                    symbolSize: 0,
                    initialTreeDepth: -1,
                    orient: 'LR',
                    layout: 'orthogonal',
                    
                    // 关键：增加节点间的间距
                    nodeGap: 40,
                    layerPadding: 280,  // 显著增加层级间距
                    
                    // 优化连接线
                    lineStyle: {
                        color: '#c0c4cc',
                        width: 1.5,
                        curveness: 0,  // 使用直线
                    },
                    
                    // 节点样式
                    itemStyle: {
                        borderWidth: 0
                    },
                    
                    label: {
                        position: 'inside',
                        distance: 0,
                        verticalAlign: 'middle',
                        align: 'center',
                        fontSize: 14,
                        padding: [8, 12],
                        color: '#fff',
                        borderRadius: 4,
                        backgroundColor: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 1,
                            y2: 1,
                            colorStops: [{
                                offset: 0,
                                color: '#8ab6f5'
                            }, {
                                offset: 1,
                                color: '#7a9fe6'
                            }]
                        }
                    },
                    
                    leaves: {
                        label: {
                            backgroundColor: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 1,
                                y2: 1,
                                colorStops: [{
                                    offset: 0,
                                    color: '#89c3bc'
                                }, {
                                    offset: 1,
                                    color: '#76ada7'
                                }]
                            }
                        }
                    },
                    
                    // 优化布局参数
                    roam: true,
                    expandAndCollapse: true,
                    animationDuration: 500,
                    animationDurationUpdate: 500,
                    
                    // 设置最大宽度比例
                    width: '80%',
                    height: '90%',
                    
                    // 优化节点对齐
                    nodeAlign: 'left',
                    
                    // 禁用力导向布局的参数
                    force: {
                        layoutAnimation: false,
                        repulsion: 0,
                        gravity: 0
                    }
                }]
            };

            // 设置容器样式
            const container = document.querySelector('.chart-wrapper');
            container.style.height = '1800px';  // 增加容器高度
            container.style.minHeight = '1200px';
            
            // 应用配置
            chart.setOption(option);
            
            // 延迟执行自动布局调整
            setTimeout(() => {
                adjustChartSize();
            }, 200);
        }

        function adjustChartSize() {
            const container = document.getElementById('chart-container');
            const wrapper = document.querySelector('.chart-wrapper');
            
            // 设置更大的容器高度以适应内容
            const minHeight = 1200;
            const height = Math.max(container.scrollHeight, minHeight);
            wrapper.style.height = height + 'px';
            
            // 重新渲染图表
            chart.resize();
        }

        // 监听窗口大小变化
        window.addEventListener('resize', () => {
            chart.resize();
            adjustChartSize();
        });

        const style = document.createElement('style');
        style.textContent = `
            .chart-wrapper {
                position: relative;
                width: 100%;
                overflow: auto;
            }
            #chart-container {
                padding: 20px;
                overflow: auto;
            }
        `;
        document.head.appendChild(style);

        // 监听搜索按钮点击
        document.getElementById('search-btn').addEventListener('click', () => {
            const industryName = document.getElementById('industry-input').value.trim();
            if (industryName) {
                fetchGraphData(industryName);
            } else {
                showError('请输入产业链名称');
            }
        });

        // 监听回车键
        document.getElementById('industry-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const industryName = e.target.value.trim();
                if (industryName) {
                    fetchGraphData(industryName);
                } else {
                    showError('请输入产业链名称');
                }
            }
        });

        // 初始化图表大小
        adjustChartSize();
    </script>
</body>
</html>